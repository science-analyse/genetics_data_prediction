<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gene Expression Cancer Classifier</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Gene Expression Cancer Classifier</h1>
            <p class="subtitle">ALL vs AML Classification</p>
        </header>

        <div class="model-info-card">
            <h2>Model Information</h2>
            <div class="info-grid">
                <div class="info-item">
                    <span class="label">Model:</span>
                    <span class="value">{{ model_info.model_name }}</span>
                </div>
                <div class="info-item">
                    <span class="label">Test Accuracy:</span>
                    <span class="value">{{ "%.2f" | format(model_info.test_accuracy * 100) }}%</span>
                </div>
                <div class="info-item">
                    <span class="label">CV Accuracy:</span>
                    <span class="value">{{ "%.2f" | format(model_info.cv_accuracy * 100) }}%</span>
                </div>
                <div class="info-item">
                    <span class="label">Features Used:</span>
                    <span class="value">{{ model_info.n_features }} genes</span>
                </div>
                <div class="info-item">
                    <span class="label">Total Genes Required:</span>
                    <span class="value">{{ model_info.total_genes_required }}</span>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="showTab('sample')">Test with Sample Data</button>
            <button class="tab-button" onclick="showTab('csv')">Upload CSV</button>
            <button class="tab-button" onclick="showTab('manual')">Manual Input</button>
        </div>

        <!-- Sample Data Tab -->
        <div id="sample-tab" class="tab-content active">
            <div class="card">
                <h2>Test with Sample Data</h2>
                <p>Load a sample from the test dataset and make a prediction.</p>
                <button class="btn btn-primary" onclick="loadSampleData()">Load Sample Data</button>
                <div id="sample-info" class="sample-info" style="display: none;">
                    <p><strong>Sample loaded:</strong> <span id="sample-genes-count"></span> genes</p>
                    <p><strong>True label:</strong> <span id="true-label"></span></p>
                </div>
                <button id="predict-sample-btn" class="btn btn-success" onclick="predictSample()" style="display: none;">
                    Make Prediction
                </button>
            </div>
        </div>

        <!-- CSV Upload Tab -->
        <div id="csv-tab" class="tab-content">
            <div class="card">
                <h2>Upload CSV File</h2>
                <p>Upload a CSV file containing gene expression data (7129 genes per sample).</p>
                <div class="file-upload">
                    <input type="file" id="csv-file" accept=".csv" onchange="handleFileSelect()">
                    <label for="csv-file" class="file-label">Choose File</label>
                    <span id="file-name"></span>
                </div>
                <button id="predict-csv-btn" class="btn btn-primary" onclick="predictFromCSV()" disabled>
                    Upload and Predict
                </button>
            </div>
        </div>

        <!-- Manual Input Tab -->
        <div id="manual-tab" class="tab-content">
            <div class="card">
                <h2>Manual Input (JSON)</h2>
                <p>Paste JSON data with gene expression values.</p>
                <div style="margin-bottom: 10px;">
                    <button class="btn btn-secondary" onclick="loadExampleJSON()">Load Example Data</button>
                </div>
                <textarea id="json-input" rows="10" placeholder='{"gene_expressions": [val1, val2, ..., val7129]}'></textarea>
                <button class="btn btn-primary" onclick="predictFromJSON()">Predict from JSON</button>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results" class="results-card" style="display: none;">
            <h2>Prediction Results</h2>
            <div id="results-content"></div>
        </div>

        <footer>
            <p>Based on Golub et al. (1999) - Molecular Classification of Cancer</p>
            <p class="api-docs">
                <a href="/docs" target="_blank">API Documentation</a> |
                <a href="/health" target="_blank">Health Check</a>
            </p>
        </footer>
    </div>

    <script>
        let sampleData = null;

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');
        }

        async function loadSampleData() {
            try {
                const response = await fetch('/api/sample-data');
                const data = await response.json();

                sampleData = data.gene_expressions;

                document.getElementById('sample-info').style.display = 'block';
                document.getElementById('sample-genes-count').textContent = data.num_genes;
                document.getElementById('true-label').textContent = data.true_label;
                document.getElementById('predict-sample-btn').style.display = 'inline-block';

                showNotification('Sample data loaded successfully!', 'success');
            } catch (error) {
                showNotification('Error loading sample data: ' + error.message, 'error');
            }
        }

        async function predictSample() {
            if (!sampleData) {
                showNotification('Please load sample data first', 'error');
                return;
            }

            try {
                const response = await fetch('/api/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(sampleData)
                });

                const result = await response.json();
                displayResults(result);
            } catch (error) {
                showNotification('Error making prediction: ' + error.message, 'error');
            }
        }

        function handleFileSelect() {
            const fileInput = document.getElementById('csv-file');
            const fileName = document.getElementById('file-name');
            const predictBtn = document.getElementById('predict-csv-btn');

            if (fileInput.files.length > 0) {
                fileName.textContent = fileInput.files[0].name;
                predictBtn.disabled = false;
            } else {
                fileName.textContent = '';
                predictBtn.disabled = true;
            }
        }

        async function predictFromCSV() {
            const fileInput = document.getElementById('csv-file');
            if (fileInput.files.length === 0) {
                showNotification('Please select a file', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch('/api/predict-csv', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                displayMultipleResults(result);
            } catch (error) {
                showNotification('Error processing CSV: ' + error.message, 'error');
            }
        }

        async function loadExampleJSON() {
            try {
                const response = await fetch('/api/sample-data');
                const data = await response.json();

                // Format as JSON with proper indentation
                const jsonData = {
                    gene_expressions: data.gene_expressions
                };

                document.getElementById('json-input').value = JSON.stringify(jsonData, null, 2);
                showNotification('Example data loaded! Click "Predict from JSON" to test.', 'success');
            } catch (error) {
                showNotification('Error loading example data: ' + error.message, 'error');
            }
        }

        async function predictFromJSON() {
            const jsonInput = document.getElementById('json-input').value;

            if (!jsonInput.trim()) {
                showNotification('Please enter JSON data', 'error');
                return;
            }

            try {
                const data = JSON.parse(jsonInput);

                const response = await fetch('/api/predict-json', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                displayResults(result);
            } catch (error) {
                if (error instanceof SyntaxError) {
                    showNotification('Invalid JSON format', 'error');
                } else {
                    showNotification('Error making prediction: ' + error.message, 'error');
                }
            }
        }

        function displayResults(result) {
            const resultsDiv = document.getElementById('results');
            const resultsContent = document.getElementById('results-content');

            const predictionClass = result.prediction === 'ALL' ? 'all-prediction' : 'aml-prediction';

            resultsContent.innerHTML = `
                <div class="prediction-result ${predictionClass}">
                    <h3>Predicted Cancer Type: ${result.prediction}</h3>
                    <p class="confidence">Confidence: ${(result.confidence * 100).toFixed(2)}%</p>
                </div>
                <div class="probabilities">
                    <h3>Probabilities</h3>
                    <div class="prob-bar-container">
                        <div class="prob-bar-label">
                            <span>ALL</span>
                            <span>${(result.probabilities.ALL * 100).toFixed(2)}%</span>
                        </div>
                        <div class="prob-bar">
                            <div class="prob-bar-fill all-bar" style="width: ${result.probabilities.ALL * 100}%"></div>
                        </div>
                    </div>
                    <div class="prob-bar-container">
                        <div class="prob-bar-label">
                            <span>AML</span>
                            <span>${(result.probabilities.AML * 100).toFixed(2)}%</span>
                        </div>
                        <div class="prob-bar">
                            <div class="prob-bar-fill aml-bar" style="width: ${result.probabilities.AML * 100}%"></div>
                        </div>
                    </div>
                </div>
                <div class="model-details">
                    <h4>Model Details</h4>
                    <p>Model: ${result.model_info.name}</p>
                    <p>Accuracy: ${(result.model_info.accuracy * 100).toFixed(2)}%</p>
                    <p>Features: ${result.model_info.n_features} genes</p>
                </div>
            `;

            resultsDiv.style.display = 'block';
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function displayMultipleResults(data) {
            const resultsDiv = document.getElementById('results');
            const resultsContent = document.getElementById('results-content');

            let html = `<h3>Batch Prediction Results (${data.total_samples} samples)</h3><div class="batch-results">`;

            data.predictions.forEach((result, index) => {
                const predictionClass = result.prediction === 'ALL' ? 'all-prediction' : 'aml-prediction';
                html += `
                    <div class="batch-result-item ${predictionClass}">
                        <strong>${result.sample_id}</strong>: ${result.prediction}
                        (${(result.confidence * 100).toFixed(1)}% confidence)
                    </div>
                `;
            });

            html += '</div>';
            resultsContent.innerHTML = html;

            resultsDiv.style.display = 'block';
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('show');
            }, 10);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>
